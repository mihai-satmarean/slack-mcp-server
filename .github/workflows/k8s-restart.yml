name: Restart Kubernetes Deployment

on:
  workflow_dispatch:
    inputs:
      deployment_name:
        description: 'Deployment name (leave empty to auto-detect)'
        required: false
        type: string
  workflow_run:
    workflows: ["Build and Push Slack MCP Server Docker Image"]
    types:
      - completed
    branches:
      - main
      - master

jobs:
  restart-deployment:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        continue-on-error: true

      - name: Configure kubeconfig
        continue-on-error: true
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Find and restart deployment
        continue-on-error: true
        run: |
          echo "Finding deployment using slack-mcp-server image..."
          
          # Use manual deployment name if provided
          if [ -n "${{ github.event.inputs.deployment_name }}" ]; then
            DEPLOYMENT="${{ github.event.inputs.deployment_name }}"
            echo "Using manually specified deployment: $DEPLOYMENT"
          else
            # Auto-detect deployment
            DEPLOYMENT=$(kubectl get deployments -n obot-mcp -o json | \
              jq -r '.items[] | select(.spec.template.spec.containers[].image | contains("slack-mcp-server")) | .metadata.name' | \
              head -1)
          fi
          
          if [ -z "$DEPLOYMENT" ]; then
            echo "No deployment found using slack-mcp-server image in obot-mcp namespace"
            echo "Available deployments:"
            kubectl get deployments -n obot-mcp
            echo ""
            echo "This is normal if the MCP server hasn't been added to Obot yet."
            exit 0
          fi
          
          echo "Found deployment: $DEPLOYMENT"
          echo "Restarting deployment to pick up new image..."
          kubectl rollout restart deployment $DEPLOYMENT -n obot-mcp
          
          echo "Waiting for rollout to complete..."
          kubectl rollout status deployment $DEPLOYMENT -n obot-mcp --timeout=300s
          
          echo "Deployment restarted successfully!"
          
          # Show pod status
          echo ""
          echo "Current pod status:"
          kubectl get pods -n obot-mcp -l app=$DEPLOYMENT -o wide

